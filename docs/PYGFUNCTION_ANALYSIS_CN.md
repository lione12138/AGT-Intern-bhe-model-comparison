# pygfunction与EED对比分析报告

## 1. 项目概述

本项目使用开源库 **pygfunction** 复现商业软件 **EED (Earth Energy Designer)** 的地埋管换热器(BHE)温度计算结果。

### 系统配置

| 参数 | 数值 |
|------|------|
| 钻孔数量 | 40 (5×8矩形布局) |
| 钻孔深度 | 147 m |
| 钻孔间距 | 7 m |
| 钻孔直径 | 140 mm |
| U型管类型 | Double-U, 32mm |

## 2. 方法演进

### 2.1 早期尝试：POINT2解析解

在使用pygfunction之前，我们最初尝试使用MODFLOW的POINT2解析解来模拟BHE温度。POINT2是用于溶质运移的2D点源解析解，理论上可以类比用于热传输：

```
热量传输 ↔ 溶质运移
温度 ↔ 浓度  
热扩散 ↔ 弥散
```

**POINT2方法的局限性**：
1. **维度限制**：POINT2是2D解，无法准确描述147m深钻孔的三维热传导
2. **无法描述热干扰**：多钻孔场的复杂热干扰需要g-function来描述
3. **偏差较大**：与EED结果偏差>3°C

**重要启示**：BHE温度计算需要专门设计的g-function方法，而非简单的点源模型。

### 2.2 转向pygfunction

基于以上经验，我们转向使用专门为BHE设计的 **pygfunction** 库。

## 3. 问题发现与解决

### 3.1 初始问题

最初使用pygfunction计算时，与EED结果存在**约3.5°C的系统性偏差**：

```
原始结果:
  pygfunction温度范围: 7.0 ~ 14.3 °C
  EED温度范围:        10.5 ~ 18.2 °C
  MAE (平均绝对误差): 3.5 °C
```

### 3.2 问题根源分析

经过详细排查，发现**两个关键错误**：

#### 错误1：热物性参数不正确

| 参数 | 错误值 | EED正确值 | 来源 |
|------|--------|-----------|------|
| 热导率 k | 2.5 W/(m·K) | **1.4 W/(m·K)** | EED输入文件 |
| 体积热容 ρc | 2.5 MJ/(m³·K) | **2.83 MJ/(m³·K)** | EED输入文件 |

#### 错误2：未考虑地热梯度

EED输入了**地热通量 0.07 W/m²**，这意味着地下温度随深度增加：

```
地温梯度 = 地热通量 / 热导率
        = 0.07 / 1.4 
        = 0.05 °C/m 
        = 50 °C/km

钻孔平均温度 = 地表温度 + 梯度 × 深度/2
            = 9.6 + 0.05 × 73.5 
            = 13.28 °C
```

**关键认识**：不能简单地使用地表温度 9.6°C 作为初始地温，而应该使用**钻孔深度范围内的平均温度 13.28°C**。

## 3. 正确的计算参数

### 3.1 EED输入参数（正确值）

```python
# 地层热物性
k_ground = 1.4        # 热导率 [W/(m·K)]
rho_c = 2.83e6        # 体积热容 [J/(m³·K)]
alpha = k / rho_c     # 热扩散系数 = 4.95×10⁻⁷ m²/s

# 钻孔热阻 (EED计算)
R_b = 0.1271          # 有效钻孔热阻 [(m·K)/W]

# 温度参数
T_surface = 9.6       # 地表温度 [°C]
q_geo = 0.07          # 地热通量 [W/m²]
T_gradient = q_geo / k_ground  # 地温梯度 = 0.05 °C/m

# 有效初始地温 (考虑地热梯度)
T0_effective = T_surface + T_gradient * H/2  # = 13.28 °C
```

### 3.2 g-function特征

```
特征时间 ts = H²/(9α) = 153.8 年

关键g值:
  g(1个月)  = 3.12
  g(1年)    = 5.04
  g(5年)    = 10.21
  g(10年)   = 14.48
  g(25年)   = 23.61
```

![g-function曲线](../figures/gfunction_curve.png)
*图: 40孔BHE场的g-function曲线*

## 4. 最终结果

### 4.1 负荷符号约定

在使用g-function时，需要注意符号约定的差异：

| 符号约定 | EED | g-function |
|----------|-----|------------|
| 正值含义 | 从地取热 (制热) | 向地注热 (使地温升高) |
| 负值含义 | 向地注热 (制冷) | 从地取热 (使地温降低) |

**关键**: 使用g-function时需要**反转EED的ground load符号**！

### 4.2 温度对比 (第25年)

| 月份 | EED [°C] | pygfunction [°C] | 误差 [°C] |
|------|----------|------------------|-----------|
| JAN | 10.5 | 10.66 | +0.16 |
| FEB | 10.6 | 10.85 | +0.25 |
| MAR | 11.3 | 11.62 | +0.32 |
| APR | 12.3 | 12.43 | +0.13 |
| MAY | 13.0 | 12.98 | -0.02 |
| JUN | 15.4 | 15.36 | -0.04 |
| JUL | 17.9 | 17.76 | -0.14 |
| AUG | 18.2 | 17.90 | -0.30 |
| SEP | 13.9 | 13.86 | -0.04 |
| OCT | 12.7 | 12.70 | 0.00 |
| NOV | 12.0 | 12.03 | +0.03 |
| DEC | 10.9 | 11.06 | +0.16 |

### 4.3 误差统计

| 指标 | 数值 |
|------|------|
| MAE (平均绝对误差) | **0.15°C** |
| R² (决定系数) | **0.999** |
| 最大误差 | **0.32°C** |

![pygfunction与EED对比结果](../figures/eed_comparison_25years.png)
*图1: pygfunction与EED温度对比（25年）*

## 5. 核心解决思路

### 5.1 方法论

```
┌─────────────────────────────────────────────────────────────┐
│  正确的pygfunction计算流程                                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 使用正确的热物性参数 (从EED输入文件获取)                   │
│     k = 1.4 W/(m·K), ρc = 2.83 MJ/(m³·K)                   │
│                                                             │
│  2. 考虑地热梯度计算有效初始地温                              │
│     T0_eff = T_surface + (q_geo/k) × H/2                   │
│            = 9.6 + 0.05 × 73.5 = 13.28°C                   │
│                                                             │
│  3. 使用pygfunction计算g-function                           │
│     - 40孔矩形场                                            │
│     - UBWT边界条件                                          │
│                                                             │
│  4. 时间叠加法计算温度响应                                    │
│     T_fluid = T0_eff + ΔT_ground + q × R_b                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 关键公式

**流体平均温度计算**：

$$T_{fluid} = T_0^{eff} + \frac{1}{2\pi k_s H} \sum_{i} \Delta q_i \cdot g(t-t_i) + q \cdot R_b$$

其中：
- $T_0^{eff} = T_{surface} + \frac{q_{geo}}{k_s} \cdot \frac{H}{2}$ （有效初始地温）
- $g(t)$ 是pygfunction计算的g-function
- $R_b = 0.1271$ (m·K)/W 是EED计算的有效钻孔热阻

## 6. 重要结论

### 6.1 技术发现

1. **热物性参数必须一致**
   - 必须使用与EED相同的 k 和 ρc 值
   - 不同的热导率会导致完全不同的g-function形状

2. **地热梯度不可忽略**
   - 对于深钻孔(>100m)，地热梯度导致的温度偏移可达3-4°C
   - 必须使用钻孔深度范围内的平均温度作为基准

3. **钻孔热阻直接使用EED值**
   - EED计算的 $R_b = 0.1271$ (m·K)/W 已经考虑了所有因素
   - 包括：流体-管壁热阻、管材热阻、回填材料热阻

### 6.2 最终精度

```
┌────────────────────────────────────────┐
│  最终结果                               │
│                                        │
│  MAE = 0.15°C                          │
│  R² = 0.999                            │
│  无需经验校准                           │
│                                        │
│  这是一个物理正确的解决方案！            │
└────────────────────────────────────────┘
```

## 7. 文件说明

### 7.1 代码文件

| 文件 | 说明 |
|------|------|
| `gfunction_pygfunction.py` | pygfunction封装模块 |
| `pygfunction_final.ipynb` | 最终分析notebook |

### 7.2 结果图表

| 图表 | 说明 |
|------|------|
| `final_comparison_pygfunction_eed.png` | pygfunction与EED对比 |
| `pygfunction_optimization_results.png` | 参数优化过程 |

## 8. 参考文献

1. Cimmino, M. (2018). pygfunction 2.1: An open-source toolbox for the evaluation of thermal response factors for geothermal borehole fields. SoftwareX.
2. Eskilson, P. (1987). Thermal Analysis of Heat Extraction Boreholes. Doctoral Thesis, Lund University.
3. BLOCON. Earth Energy Designer (EED) Software Manual.

---

*文档版本: 2.0*  
*创建日期: 2025年12月*  
*作者: Liuhuang Luo*


